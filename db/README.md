Схема БД https://dbdiagram.io/d/68f9cd92357668b732387a54

### Общие допущения для расчетов
    - Общая нагрузка на систему: ~350 RPS на запись, ~11k RPS на чтение.
    - Емкость диска: 2 TB.
    - Пропускная способность дисков (последовательное чтение/запись):
        - HDD: ~150 MB/с
        - SSD: ~500 MB/с
        - NVMe: ~2000 MB/с (2 GB/с)


        11000 * 6 * 200 = 13GB

### Посты
    - Шардируем по ключу post_id
    - Репликация: 3 - master-slave (1 мастер, 2 реплики)

    - Количество постов в год: 10_000_000 пользователей * 1 пост/неделю * 52 недели = 520_000_000 постов.
    - Размер одного поста (текст): 2000 символов (UTF-8) ~ 4 KB.
    - Размер фотографий для одного поста: 6 фото * 200 KB = 1.2 MB.
    - Общий объем данных для постов в год (без репликации):
       - Текст: 520_000_000 * 4 KB = ~2 TB.
       - Фото (S3): 520_000_000 * 1.2 MB = ~624 TB. (реальный объем x8 = 6PB)
    - Общий объем с репликацией (только для PostgreSQL): 2 TB * 3 = 6 TB.
    - Оценка I/O: Предположим RPS чтения (11000 RPS) и RPS записи (350 RPS). Средний размер операции ~5 KB (4 KB + метаинформация).
        - Чтение: 11000 RPS * 5 KB = 55 MB/с
        - Запись: 350 RPS * 5 KB = ~2 MB/с
        - Суммарный I/O: ~57 MB/с

    - Требуется дисков (по емкости, 2 TB/диск): 6 TB / 2 TB/диск = 3 диска.
    - Требуется дисков (по пропускной способности):
        - HDD: 57 MB/с / 150 MB/с/диск = 1 диск.
        - SSD: 57 MB/с / 500 MB/с/диск = 1 диск.
        - NVMe: 57 MB/с / 2000 MB/с/диск = 1 диск.
    - Требуется хостов (PostgreSQL):
        - По RPS (CPU/память): 11000 RPS / 1500 RPS/хост = 8 хостов.
        -                      350 RPS / 500 RPS/хост = 1 хост.
        - 11000 / 1500 = 8 (небходимо реплик для чтения)
        -
        - С учетом шардирования на 4 шарда (мастер + 2 реплики на шард), потребуется 4 шарда * 3 хоста/шард = 12 хостов.

### Комментарии
    - Шардируем по ключу post_id
    - Репликация: 3 - master-slave (1 мастер, 2 реплики)

    - Количество комментариев в год: 10_000_000 пользователей * 3 комментария/день * 365 дней = 10_950_000_000 комментариев.
    - Размер одного комментария: 500 символов (UTF-8) ~ 1 KB.
    - Общий объем данных для комментариев в год (без репликации): 10_950_000_000 * 1 KB = ~11 TB.
    - Общий объем с репликацией: 11 TB * 3 = 33 TB.
    - Оценка I/O: Предположим RPS чтения (11000 RPS) и RPS записи (350 RPS). Средний размер операции ~1 KB.
        - Чтение: 11000 RPS * 1 KB = 11 MB/с
        - Запись: 350 RPS * 1 KB = 0,3 MB/с
        - Суммарный I/O: ~11 MB/с

    - Требуется дисков (по емкости, 2 TB/диск): 33 TB / 2 TB/диск = 17 дисков (объединим в RAID. 3 хоста по 6 дисков).
    - Требуется дисков (по пропускной способности):
        - HDD: 11 MB/с / 150 MB/с/диск = 1 диск.
        - SSD: 11 MB/с / 500 MB/с/диск = 1 диск.
        - NVMe: 11 MB/с / 2000 MB/с/диск = 1 диск.
    - Требуется хостов (PostgreSQL):
        - По RPS (CPU/память): 11000 RPS / 1500 RPS/хост = 8 хостов.
        -                        350 RPS / 500 RPS/хост = 1 хост.
        - С учетом шардирования на 4 шарда (мастер + 2 реплики на шард), потребуется 4 шарда * 3 хоста/шард = 12 хостов.

### Реакции
    Kafka: 3 реплики, retantion - 3 дня.
    Postgres: 3 реплики, master-slave (1 мастер, 2 реплики).

    Так как оценки агрегируются, объем данных в rating_agg будет равен количеству постов.
    - Объем данных для `rating_agg` в год (без репликации): 520_000_000 записей * (16 байт post_id + 4 байта sum_rating + 4 байта count_rating) ~ 12.5 GB.
    - Общий объем с репликацией: 12.5 GB * 3 = 37.5 GB.
    - Оценка I/O (PostgreSQL для агрегаций): Предположим RPS чтения (11000 RPS, по RPS просмотра постов). Средний размер операции ~24 байта.
        - Чтение: 11000 RPS * 24 байта = ~0.3 MB/с
        - Запись: 3500 RPS * 24 байта = ~0.09 MB/с
        - Суммарный I/O: ~0.4 MB/с

    - Требуется дисков (по емкости, 2 TB/диск): 37.5 GB.
    - Требуется дисков (по пропускной способности): I/O крайне низкий, не является ограничивающим фактором для любого типа диска.

    - Требуется хостов (Kafka для записи):
        - Оценка нагрузки: 100% от общего RPS записи реакций (3500 RPS). Средний размер сообщения ~100 байт.
        - Пропускная способность: 3500 RPS * 100 байт = 0.35 MB/с.
        - Производительность хоста Kafka: ~100 MB/с.
        - Для обеспечения высокой доступности и 3 реплик, потребуется минимум 3 Kafka брокера = 3 хоста.
    - Требуется хостов (PostgreSQL для агрегаций):
        - По RPS (CPU/память): 11000 RPS / 10000 RPS/хост = 2 хоста.
        -                      3500 RPS / 5000 RPS/хост = 1 хоста.
        - 1 шарда * 3 хоста/шард = 3 хоста.

### Подписки
    - Шардируем по ключу user_id
    - Репликация: 3 - master-slave (1 мастер, 2 реплики)

    - Количество подписок: 10_000_000 пользователей * 50 подписок/пользователя = 500_000_000 подписок.
    - Размер одной подписки: user_id (16 байт) + subscriber_id (16 байт) = 32 байта.
    - Общий объем данных для подписок (без репликации): 500_000_000 * 32 байта = 16 GB.
    - Общий объем с репликацией: 16 GB * 3 = 48 GB.
    - Оценка I/O: Предположим RPS чтения (500 RPS) и RPS записи (16 RPS). Средний размер операции ~32 байта.
        - Чтение: 500 RPS * 50 подписок * 32 байта = 8 MB/с
        - Запись: 16 RPS * 32 байта = 0.0005 MB/с
        - Суммарный I/O: ~8 MB/с

    - Требуется дисков (по емкости, 2 TB/диск): 48 GB.
    - Требуется хостов (PostgreSQL):
        - По RPS (CPU/память): (500 + 16) RPS / 10000 RPS/хост = 1 хост.
        - По I/O: I/O не является узким местом.
        - 1 шарда * 3 хоста/шард = 3 хостов.

## Итог
    - Общий объем данных (с репликацией): 6 TB (посты) + 33 TB (комментарии) + 37.5 GB (рейтинги) + 48 GB (подписки) = ~40 TB.
    - Общее количество дисков (по 2 TB): 3 (посты) + 17 (комментарии) = 20 дисков.
    - Общее количество хостов:
        - PostgreSQL для постов: 12 хоста
        - PostgreSQL для комментариев: 12 хостов
        - Kafka для реакций: 3 хоста
        - PostgreSQL для агрегаций реакций: 3 хоста
        - PostgreSQL для подписок: 3 хоста
        - Итого: 12 + 12 + 3 + 3 + 3 = 33 хост.
